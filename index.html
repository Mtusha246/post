<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Social API Tester</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    label, input, textarea, button { display: block; margin-top: 1em; }
    #posts { margin-top: 2em; }
    .post { border: 1px solid #bbb; padding: 1em; margin-bottom: 1em; border-radius: 8px; background: #f7f7f9; }
    .comments { margin-left: 2em; margin-top: 0.7em; }
    .comment { margin-bottom: 0.6em; }
    .actions { margin-top: 1em; }
    input[type="text"] { width: 350px; }
    textarea { width: 350px; height: 60px; }
  </style>
</head>
<body>
  <h2>Social API Viewer</h2>
  <label for="backendUrl">Backend API URL:</label>
  <input id="backendUrl" type="text" value="http://localhost:3000">
  <button onclick="fetchPosts()">Fetch Posts</button>

  <h3>Create a New Post</h3>
  <textarea id="postContent" placeholder="Write your post..."></textarea>
  <button onclick="createPost()">Create Post</button>

  <div id="posts"></div>

  <script>
    function getApiUrl() {
      const url = document.getElementById('backendUrl').value.trim();
      return url || 'http://localhost:3000';
    }

    async function fetchPosts() {
      const url = getApiUrl();
      document.getElementById('posts').textContent = 'Loading...';
      try {
        const res = await fetch(`${url}/posts`);
        if (!res.ok) throw new Error('Failed to fetch posts');
        const posts = await res.json();
        renderPosts(posts);
      } catch (err) {
        document.getElementById('posts').textContent = 'Error: ' + err;
      }
    }

    async function createPost() {
      const url = getApiUrl();
      const content = document.getElementById('postContent').value.trim();
      if (!content) {
        alert('Please enter some post content.');
        return;
      }
      try {
        const res = await fetch(`${url}/posts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });
        if (!res.ok) throw new Error('Failed to create post');
        document.getElementById('postContent').value = '';
        fetchPosts();
      } catch (err) {
        alert('Error: ' + err);
      }
    }

    async function deletePost(postId) {
      const url = getApiUrl();
      if (!confirm('Delete post #' + postId + '?')) return;
      try {
        const res = await fetch(`${url}/posts/${postId}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to delete post');
        fetchPosts();
      } catch (err) {
        alert('Error: ' + err);
      }
    }

    async function addComment(postId) {
      const url = getApiUrl();
      const input = document.getElementById(`commentInput-${postId}`);
      const commentContent = input.value.trim();
      if (!commentContent) {
        alert('Please enter some comment text.');
        return;
      }
      try {
        const res = await fetch(`${url}/posts/${postId}/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ commentContent })
        });
        if (!res.ok) throw new Error('Failed to add comment');
        input.value = '';
        fetchPosts();
      } catch (err) {
        alert('Error: ' + err);
      }
    }

    function renderPosts(posts) {
      const postsDiv = document.getElementById('posts');
      if (!Array.isArray(posts) || posts.length === 0) {
        postsDiv.innerHTML = '<i>No posts found.</i>';
        return;
      }
      postsDiv.innerHTML = posts.map(post => `
        <div class="post">
          <b>Post #${post.id}</b><br>
          <span>${escapeHtml(post.content)}</span>
          <div class="actions">
            <button onclick="deletePost(${post.id})">Delete</button>
          </div>
          <div class="comments">
            <b>Comments:</b>
            <div>
              ${Array.isArray(post.comments) && post.comments.length > 0
                ? post.comments.map(comment => `<div class='comment'>#${comment.id}: ${escapeHtml(comment.content)}</div>`).join('')
                : '<i>No comments</i>'
              }
            </div>
            <input id="commentInput-${post.id}" type="text" placeholder="Add a comment...">
            <button onclick="addComment(${post.id})">Add Comment</button>
          </div>
        </div>
      `).join('');
    }

    function escapeHtml(string) {
      return string.replace(/[&<>"]/g, function (c) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c];
      });
    }

    // Auto-fetch posts on initial load
    fetchPosts();
  </script>
</body>
</html>
